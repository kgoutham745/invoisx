<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>INVOISX - Finance</title>
    <link rel="icon" type="image/jpg" href="/assets/images/logo.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template -->
    <!-- <link href="css/sb-admin-2.min.css" rel="stylesheet"> -->
    <link href="css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

</head>

<body class="bg-light-subtle py-5">

    <!--navbar-->
    <nav class="navbar bg-body-tertiary shadow  fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="/assets/images/logo.jpg" alt="Logo" width="50" class="d-inline-block align-text-top">
                INVOISX
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title text-primary" id="offcanvasNavbarLabel">INVOISX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                        <li class="nav-item bg-primary-subtle px-3">
                            <a class="nav-link active" aria-current="page" href="#">Admin</a>
                        </li>
                        <li class="nav-item m-1">
                            <button class="btn btn-outline-info" id="logoutBtn">Logout</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!--card showing numbers-->
    <div class="container-fluid mt-4 text-center">
        <div class="card text-bg-light mb-3 shadow-lg">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="p-3 bg-success border border-0 rounded-2 bg-gradient text-white" id="paidN">Paid:0</div>
                    </div>
                    <div class="col">
                        <div class="p-3 bg-warning border border-0 rounded-2 bg-gradient text-white" id="approvedN">Approved:0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--records from database-->
    <div class="container-fluid">
        <!-- DataTales Example -->
        <div class="card shadow-lg mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">List of Invoices:</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </tfoot>
                        <tbody id="invoicesList">
                            <!-- <tr>
                                <td>Date</td>
                                <td>Status</td>
                                <td>Location</td>
                                <td>Action</td>
                            </tr> -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Button trigger modal -->
    <button type="button" style="display: none;" id="launchModal" class="btn btn-primary" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop">
    </button>

    <!-- Modal -->
    <div class="modal fade " id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-xl-down modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Invoice</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-3">
                        <div class="row g-0">
                            <div class="col-md-8">
                                <img src="" id="modalImg" class="img-fluid rounded-start">
                            </div>
                            <div class="col-md-4">
                                <div class="card-body border-top">
                                    <h5 class="card-title text-primary p-1 rounded bg-primary-subtle">Comments:</h5>
                                    <div class="admincmtbox bg-primary-subtle p-1 rounded m-1">
                                        <h6 class="text-primary">
                                            Admin:<p class="text-center text-black" id="admcmt"></p>
                                        </h6>
                                    </div>
                                    <div id="fincmtbox" class="bg-primary-subtle p-1 rounded m-1" style="display: none;">
                                        <h6 class="text-primary">
                                            Financer:<p class="text-center text-black" id="fincmt"></p>
                                        </h6>
                                        <textarea class="form-control" id="cmtbox" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-secondary" id="deleteBtn">Delete</button>
                <button type="button" class="btn btn-danger" id="rejectBtn">Reject</button>
                <button type="button" class="btn btn-success" id="approveBtn">Pay</button>
                <input style="display:none" ; value="" id="modalInvoiceId"></input>
                <input style="display:none" ; value="" id="modalInvoiceLocation"></input>
                <input style="display:none" ; value="" id="modalInvoiceStatus"></input>
            </div>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-primary" style="display: none;" id="launchSpinnerModal" data-bs-toggle="modal" data-bs-target="#staticBackdrop2">
    </button>
    
    <!-- spinner modal -->
    <div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="staticBackdropLabel">Please Wait!</h1>
          </div>
          <div class="modal-body text-center">
              <!-- loading spinner -->
              <button class="btn btn-primary" type="button">
                  <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  Loading...
                </button>
          </div>
          <div class="modal-footer">
          </div>
        </div>
      </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getDatabase, ref as dRef, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyCuhiAVSXUbzJseqTn8V9JIrSlq_g0GzoE",
            authDomain: "eroth-consultancy.firebaseapp.com",
            databaseURL: "https://eroth-consultancy-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "eroth-consultancy",
            storageBucket: "eroth-consultancy.appspot.com",
            messagingSenderId: "682903429693",
            appId: "1:682903429693:web:26c55686d06d2e4b7c8054",
            measurementId: "G-WL22HQMBKJ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const locations = ['kukatpally', 'tarnaka', 'malakpet'];
        onAuthStateChanged(auth, (user) => {
        if (user) {
            // User is signed in, see docs for a list of available properties
            // https://firebase.google.com/docs/reference/js/firebase.User
            console.log();
            // ...
        } else {
            // User is signed out
            // ...
            window.location = 'index.html';
        }
        });

        const dbRef = dRef(getDatabase());
        locations.forEach(location => {
            get(child(dbRef, `${location}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const invoiceObj = {};
                    snapshot.forEach(function (childSnapshot) {
                        invoiceObj['key'] = childSnapshot.key;
                        childSnapshot.forEach(function (grandChildSnapshot) {
                            invoiceObj[grandChildSnapshot.key] = grandChildSnapshot.val();
                        });
                        // `<tr>
                        // <td style="display:none;"><input value="${invoiceObj.key}"></input></td>
                        // <td style="display:none;"><input value="${invoiceObj.location}"></input></td>
                        // <td style="display:none;"><input value="${invoiceObj.status}"></input></td>
                        // <td style="display:none;"><input value="${invoiceObj.link}"></input></td>
                        // <td>${invoiceObj.date.substring(0,16)}</td>
                        // <td><div class="badge text-bg-${color}">${invoiceObj.status}</div></td>
                        // <td>${invoiceObj.location}</td>
                        // <td><button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this.parentNode.parentNode)">Details</button></td>
                        // </tr>`
                        
                        const status=`${invoiceObj.status}`;
                        const fincmt=`${invoiceObj.fincmt}`;
                        const admcmt=`${invoiceObj.admcmt}`;

                        if (invoiceObj.status == 'approved') {
                            document.getElementById('approvedN').innerHTML = 'Approved: ' + (parseInt(document.getElementById('approvedN').innerHTML.split(':')[1]) + 1);
                           
                            addTableRow(`${invoiceObj.date.substring(0,16)}`,`<div class="badge text-bg-warning">${invoiceObj.status}</div>`,`${invoiceObj.location}`,`<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"><input style="display:none;" value="${invoiceObj.key}"></input><input style="display:none;" value="${invoiceObj.location}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('warning',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }
                        else if (invoiceObj.status == 'paid') {
                           
                            
                            document.getElementById('paidN').innerHTML = 'Paid: ' + (parseInt(document.getElementById('paidN').innerHTML.split(':')[1]) + 1);
                            addTableRow(`${invoiceObj.date.substring(0,16)}`,`<div class="badge text-bg-success">${invoiceObj.status}</div>`,`${invoiceObj.location}`,`<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"><input style="display:none;" value="${invoiceObj.key}"></input><input style="display:none;" value="${invoiceObj.location}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('success',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }

                        
                    });
                }
            }).catch((error) => {
                console.error(error);
            });
        });


        //paying the vendor 
        async function payInvoice() {
            document.getElementById('launchSpinnerModal').click();
            const db = getDatabase();
            const updates = {};
            const id = document.getElementById('modalInvoiceId').value;
            const location = document.getElementById('modalInvoiceLocation').value;
            let text="No Comments :)"
            if(document.getElementById('cmtbox').value.trim().length>0)
             text=document.getElementById('cmtbox').value;
           

            updates[`/${location}/` + id + '/status'] = "paid";
            updates[`/${location}/` + id + '/fincmt'] = text;
            update(dRef(db), updates).then(()=> history.go() ).catch((error)=> console.log(error));
            
        }


        //rejecting the invoice        
        async function rejectInvoice() {
            document.getElementById('launchSpinnerModal').click();
            const db = getDatabase();
            const updates = {};
            const id = document.getElementById('modalInvoiceId').value;
            const location = document.getElementById('modalInvoiceLocation').value;
            updates[`/${location}/` + id + '/status'] = "rejected";
            update(dRef(db), updates);
            history.go();
        }

        //deleting the invoice
        async function deleteInvoice() {
            document.getElementById('launchSpinnerModal').click();
            const db = getDatabase();
            const id = document.getElementById('modalInvoiceId').value;
            const location = document.getElementById('modalInvoiceLocation').value;
            remove(dRef(db, `${location}/${id}`));
            history.go();
        }
        

        //event Listners        
        document.getElementById('approveBtn').onclick = payInvoice;
        document.getElementById('rejectBtn').onclick = rejectInvoice;
        document.getElementById('deleteBtn').onclick = deleteInvoice; 
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    window.location = 'index.html';
                })
                .catch((error) => {
                    console.log(error);
                });
        });

        //getting the table row

        //not used
        function getInvoiceCard(color, invoiceObj) {
            return `<tr>
                        <td style="display:none;"><input value="${invoiceObj.key}"></input></td>
                        <td style="display:none;"><input value="${invoiceObj.location}"></input></td>
                        <td style="display:none;"><input value="${invoiceObj.status}"></input></td>
                        <td style="display:none;"><input value="${invoiceObj.link}"></input></td>
                        <td>${invoiceObj.date.substring(0,16)}</td>
                        <td><div class="badge text-bg-${color}">${invoiceObj.status}</div></td>
                        <td>${invoiceObj.location}</td>
                        <td><button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this.parentNode.parentNode)">Details</button></td>
                    </tr>`;
        }

        //adding row
        function addTableRow(a,b,c,d){
            var table = $('#dataTable').DataTable();
            table.row.add( [ a,b,c,d ] ).draw();
        }
        
        // addTableRow(1,2,2,'<input type="text" value="hi">');
        
        // setTimeout(() => {
        //     var table = $('#dataTable').DataTable();
        //     table.row.add( [ "1","2","3","4" ] ).draw();
        // }, 5000);
        

        //logout listner        
        document.getElementById('logoutBtn').addEventListener('click',()=>{
        signOut(auth)
            .then(() => {
            window.location = 'index.html';
            })
            .catch((error) => {
            console.log(error);
            });
        });
        
    </script>
    <script>

        /*open invoice and ask comment if paying else show comment*/
        function openInvoice(e,status,fincmt,admcmt) {
           
            const id = e.nextElementSibling.nextElementSibling.value;
            const loc = e.nextElementSibling.nextElementSibling.nextElementSibling.value;
            const url = e.nextElementSibling.value;

            document.getElementById('launchModal').click();

        
            document.getElementById('admcmt').innerText = `${admcmt}`

            if (status == "paid") {
                document.getElementById('cmtbox').style.display='none'
                document.getElementById('rejectBtn').style.display = 'none';
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('fincmt').style.display='block'
                document.getElementById('fincmt').innerText = `${fincmt}`

            } else {
                document.getElementById('cmtbox').style.display='block'
                document.getElementById('fincmt').style.display='none'
                document.getElementById('rejectBtn').style.display = 'block';
                document.getElementById('approveBtn').style.display = 'block';
            }
            
            document.getElementById('modalInvoiceLocation').value = loc;
            document.getElementById('modalInvoiceId').value = id;
            document.getElementById('modalImg').src = url;
           
        } 
        
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>
</body>

</html>
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link rel="icon" type="image/jpg" href="/assets/images/logo.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <!-- Custom fonts for this template -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template -->
    <!-- <link href="css/sb-admin-2.min.css" rel="stylesheet"> -->
    <link href="css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

    <style>
        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body class="bg-light-subtle py-5">
    <nav class="navbar bg-body-tertiary shadow  fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="/assets/images/logo.jpg" alt="Logo" width="50" class="d-inline-block align-text-top">
                INVOISX
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title text-primary" id="offcanvasNavbarLabel">INVOISX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                        <li class="nav-item bg-primary-subtle px-3">
                            <a class="nav-link active" aria-current="page" href="#">Home</a>
                        </li>
                        <li class="nav-item m-1">
                            <button class="btn btn-outline-info" id="logoutBtn">Logout</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 text-center">
        <div class="card text-bg-light mb-3 shadow-lg">
            <div class="card-header bg-white">Upload Invoice</div>
            <div class="card-body">
                <p class="card-text">Take or select photo(s)</p>
                <label class="btn btn-info">
                    <input type="file" class="btn btn-warning" id="fileToUpload" name="fileToUpload"
                        accept="image/png, image/jpeg, image/jpg">
                    Choose file
                </label>
                <p id="fileName"></p>
                <div>
                    <select class="btn btn-info" style="display: none;" name="location" id="location">
                        <option class="dropdown-item" value="kukatpally">kukatpally</option>
                        <option class="dropdown-item" value="tarnaka">tarnaka</option>
                        <option class="dropdown-item" value="malakpet">malakpet</option>
                    </select>
                </div>
                <div>
                    <input type="button" class="btn btn-light border border-dark" id="uploadBtn" value="Upload" />
                </div>
                <div id="progress"></div>
                <div id="msg"></div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4 text-center">
        <div class="card text-bg-light mb-3 shadow-lg">
            <!-- <div class="card-header bg-white">Upload Invoice</div> -->
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="p-3 bg-primary border border-0 rounded-2 bg-gradient text-white" id="pendingN">
                            Pending:0</div>
                    </div>
                    <div class="col">
                        <div class="p-3 bg-success border border-0 rounded-2 bg-gradient text-white" id="paidN">Paid:0
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="p-3 bg-danger border border-0 rounded-2 bg-gradient text-white" id="rejectedN">
                            Rejected:0</div>
                    </div>
                    <div class="col">
                        <div class="p-3 bg-warning border border-0 rounded-2 bg-gradient text-white" id="approvedN">
                            Approved:0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- DataTales Example -->
        <div class="card shadow-lg mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">List of Invoices:</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </tfoot>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Button trigger modal -->
    <button type="button" style="display: none;" id="launchModal" class="btn btn-primary" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop">
    </button>

    <!-- Modal -->
    <div class="modal fade " id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-xl-down modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Invoice</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-3">
                        <div class="row g-0">
                            <div class="col-md-8">
                                <img src="" id="modalImg" class="img-fluid rounded-start">
                            </div>
                            <div class="col-md-4">
                                <div class="card-body border-top">
                                    <h5 class="card-title">Comments</h5>
                                    <p class="card-text">Admin:</p>
                                    <p class="card-text">Financer:</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <input style="display:none" ; value="" id="modalInvoiceId"></input>
                <input style="display:none" ; value="" id="modalInvoiceLocation"></input>
                <input style="display:none" ; value="" id="modalInvoiceStatus"></input>
            </div>
        </div>
    </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getDatabase, ref as dRef, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyCuhiAVSXUbzJseqTn8V9JIrSlq_g0GzoE",
            authDomain: "eroth-consultancy.firebaseapp.com",
            databaseURL: "https://eroth-consultancy-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "eroth-consultancy",
            storageBucket: "eroth-consultancy.appspot.com",
            messagingSenderId: "682903429693",
            appId: "1:682903429693:web:26c55686d06d2e4b7c8054",
            measurementId: "G-WL22HQMBKJ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const userObj = JSON.parse(localStorage.getItem("invoisx"));
        const location = userObj["location"];
        const locations = ['kukatpally', 'tarnaka', 'malakpet'];
        await onAuthStateChanged(auth, (user) => {
            if (user) {
            // User is signed in, see docs for a list of available properties
            // https://firebase.google.com/docs/reference/js/firebase.User
            console.log();
            // ...
            } else {
            // User is signed out
            // ...
            window.location = 'index.html';
            }
        });

        var proglab = document.getElementById('progress');
        var files = [];
        var reader = new FileReader();
        var input = document.getElementById('fileToUpload');
        input.onchange = e => {
            files = e.target.files;
            reader.readAsDataURL(files[0]);
            document.getElementById('fileName').innerHTML = files[0].name;
        }

        // const location = document.getElementById("location").value;
        console.log(location);
        async function UploadProcess() {
            if (files.length == 0) {
                return;
            }
            var ImgToUpload = files[0];
            const storage = getStorage();
            var date = new Date().toString();
            console.log(date);
            const storageRef = sRef(storage, location + "/" + date);
            const UploadTask = uploadBytesResumable(storageRef, ImgToUpload);
            UploadTask.on('state-changed', (snapshot) => {
                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                proglab.innerHTML = "Upload " + progress + "%";
            },
                (error) => {
                    alert("error while uploading img!");
                }, async () => {
                    var dataContains = "";
                    var fd = new FormData();
                    fd.append('file', files[0]);
                    document.getElementById('msg').innerHTML = "OCR scanning please wait!";
                    // await fetch("http://192.168.1.10:5000/img", { method: "post", body: fd })
                    //     .then(res => res.json())
                    //     .then(json => {
                    //         console.log(json.data);
                    //         dataContains = json.data;
                    //         document.getElementById('msg').innerHTML = "Success" + json.data;
                    //     })
                    //     .catch(err => document.getElementById('msg').innerHTML = "Success! Please Refresh!");

                    await getDownloadURL(UploadTask.snapshot.ref).then((downlaodURL) => {
                        const db = getDatabase();
                        const postData = {
                            date: date,
                            title: "",
                            location: location,
                            data: dataContains,
                            status: "pending",
                            link: downlaodURL
                        }
                        console.log(date);
                        const updates = {};
                        const newPostKey = push(child(dRef(db), location)).key;
                        updates[`/${location}/` + newPostKey] = postData;

                        update(dRef(db), updates);
                    });
                    document.getElementById('msg').innerHTML = "Success! Please Refresh!";
                });
        }
        uploadBtn.onclick = UploadProcess;

        const dbRef = dRef(getDatabase());
        locations.forEach(location => {
            get(child(dbRef, `${location}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const invoiceObj = {};
                    snapshot.forEach(function (childSnapshot) {
                        invoiceObj['key'] = childSnapshot.key;
                        childSnapshot.forEach(function (grandChildSnapshot) {
                            invoiceObj[grandChildSnapshot.key] = grandChildSnapshot.val();
                        });
                        if (invoiceObj.status == 'approved') {
                            document.getElementById('approvedN').innerHTML = 'Approved: ' + (parseInt(document.getElementById('approvedN').innerHTML.split(':')[1]) + 1);
                            addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-warning">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this)">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('warning',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }
                        else if (invoiceObj.status == 'pending') {
                            document.getElementById('pendingN').innerHTML = 'Pending: ' + (parseInt(document.getElementById('pendingN').innerHTML.split(':')[1]) + 1);
                            addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-primary">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this)">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('primary',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }
                        else if (invoiceObj.status == 'rejected') {
                            document.getElementById('rejectedN').innerHTML = 'Rejected: ' + (parseInt(document.getElementById('rejectedN').innerHTML.split(':')[1]) + 1);
                            addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-danger">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this)">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('danger',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }
                        else if (invoiceObj.status == 'paid') {
                            document.getElementById('paidN').innerHTML = 'Paid: ' + (parseInt(document.getElementById('paidN').innerHTML.split(':')[1]) + 1);
                            addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-success">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this)">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('success',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }

                    });
                }
            }).catch((error) => {
                console.error(error);
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    window.location = 'index.html';
                })
                .catch((error) => {
                    console.log(error);
                });
        });

        function addTableRow(a, b, c, d) {
            var table = $('#dataTable').DataTable();
            table.row.add([a, b, c, d]).draw();
        }
        document.getElementById('logoutBtn').addEventListener('click',()=>{
        signOut(auth)
            .then(() => {
            window.location = 'index.html';
            })
            .catch((error) => {
            console.log(error);
            });
        });

    </script>
    <script>
        function openInvoice(e) {
            const url = e.nextElementSibling.value;
            document.getElementById('modalImg').src = url;
            document.getElementById('launchModal').click();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>
</body>

</html>
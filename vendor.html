<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>INVOISX - Vendor</title>
    <link rel="icon" type="image/jpg" href="/assets/images/logo.jpg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template -->
    <!-- <link href="css/sb-admin-2.min.css" rel="stylesheet"> -->
    <link href="css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">


</head>


<body class="bg-light-subtle py-5" id="body" style="visibility: hidden;">


    <nav class="navbar bg-body-tertiary shadow  fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="/assets/images/logo.jpg" alt="Logo" width="50" class="d-inline-block align-text-top">
                INVOISX
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title text-primary" id="offcanvasNavbarLabel">INVOISX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                        <li class="nav-item bg-primary-subtle px-3">
                            <a class="nav-link active" aria-current="page" href="#">Home</a>
                        </li>
                        <li class="nav-item m-1">
                            <button class="btn btn-outline-info" id="logoutBtn">Logout</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!--upload image-->
    <div class="container-fluid mt-4 text-center">
        <div class="card text-bg-light mb-3 shadow-lg">
            <div class="card-header bg-white">Upload Invoice</div>
            <div id="msg" style="visibility: hidden;font-size: large;margin-top: 10px;">Success! Please Refresh!</div>
            <div class="input-group mb-3" style="width: 80vw;align-self: center;margin: 25px;">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" id="fileToUpload" name="fileToUpload" style="cursor: pointer;"
                        accept="image/png, image/jpeg, image/jpg">
                    <label class="custom-file-label" for="fileToUpload" id="fileName" style="text-align: center;">Select / Drop</label>
                </div>
            </div>
            <div>
                <input type="button" class="btn btn-light border border-dark" id="uploadBtn" value="Upload" />
            </div>
            <div class="progress m-3" id="progressbar" style="visibility:hidden;" role="progressbar"
                aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar progress-bar-striped" id="progressval" style="width: 10%;">10%</div>
            </div>






            <!--
                    for testing different vendors
                    <div>
                    <select class="btn btn-info" style="display: none;" name="location" id="location">
                        <option class="dropdown-item" value="kukatpally">kukatpally</option>
                        <option class="dropdown-item" value="tarnaka">tarnaka</option>
                        <option class="dropdown-item" value="malakpet">malakpet</option>
                    </select>
                </div>
            -->




        </div>

    </div>


    <!--numbers-->
    <div class="container-fluid mt-4 text-center">
        <div class="card text-bg-light mb-3 shadow-lg">
            <!-- <div class="card-header bg-white">Upload Invoice</div> -->
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="p-3 bg-primary border border-0 rounded-2 bg-gradient text-white" id="pendingN" onclick="customSearch(this)" style="cursor: pointer;">
                            Pending:0</div>
                    </div>
                    <div class="col">
                        <div class="p-3 bg-warning border border-0 rounded-2 bg-gradient text-white" id="approvedN" onclick="customSearch(this)" style="cursor: pointer;">
                            Approved:0</div>
                    </div>

                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="p-3 bg-danger border border-0 rounded-2 bg-gradient text-white" id="rejectedN" onclick="customSearch(this)" style="cursor: pointer;">
                            Rejected:0</div>
                    </div>

                    <div class="col">
                        <div class="p-3 bg-success border border-0 rounded-2 bg-gradient text-white" id="paidN" onclick="customSearch(this)" style="cursor: pointer;">Paid:0
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!--uploaded invoices-->
    <div class="container-fluid">
        <!-- DataTales Example -->
        <div class="card shadow-lg mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">List of Invoices:</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </tfoot>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer" style="height: 2vh;text-align: center;">
        <p>
            All rights reserved &copy; 2023;
        </p>
    </div>

    <!-- Button trigger modal -->
    <button type="button" style="display: none;" id="launchModal" class="btn btn-primary" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop">
    </button>


    <!-- Modal -->
    <div class="modal fade " id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-xl-down modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Invoice</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card mb-3">
                        <div class="row g-0">
                            <div class="col-md-8">
                                <img src="" id="modalImg" class="img-fluid rounded-start">
                            </div>
                            <div class="col-md-4">
                                <div class="card-body">
                                    <h5 class="card-title text-primary p-1 rounded bg-primary-subtle">Comments:</h5>
                                    <div class="admincmtbox bg-primary-subtle p-1 rounded m-1">
                                        <h6 class="text-primary">
                                            Admin:<p class="text-center text-black" id="admcmt"></p>
                                        </h6>
                                    </div>
                                    <div id="fincmtbox" class="bg-primary-subtle p-1 rounded m-1"
                                        style="display: none;">
                                        <h6 class="text-primary">
                                            Financer:<p class="text-center text-black" id="fincmt"></p>
                                        </h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <!--delete invoice feature in updates-->
                    <button type="button" class="btn btn-outline-secondary" id="deleteBtn">Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <input style="display:none" ; value="" id="modalInvoiceId"></input>
                    <input style="display:none" ; value="" id="modalInvoiceLocation"></input>
                    <input style="display:none" ; value="" id="modalInvoiceStatus"></input>
                </div>
            </div>
        </div>
    </div>

    <button type="button" class="btn btn-primary" style="display: none;" id="launchSpinnerModal" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop2">
    </button>

    <!-- spinner modal -->
    <div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Please Wait!</h1>
                </div>
                <div class="modal-body text-center">
                    <!-- loading spinner -->
                    <button class="btn btn-primary" type="button">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Loading...
                    </button>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getDatabase, ref as dRef, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyCuhiAVSXUbzJseqTn8V9JIrSlq_g0GzoE",
            authDomain: "eroth-consultancy.firebaseapp.com",
            databaseURL: "https://eroth-consultancy-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "eroth-consultancy",
            storageBucket: "eroth-consultancy.appspot.com",
            messagingSenderId: "682903429693",
            appId: "1:682903429693:web:26c55686d06d2e4b7c8054",
            measurementId: "G-WL22HQMBKJ"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const userObj = JSON.parse(localStorage.getItem("invoisx"));
        const location = userObj["location"];
        const locations = ['kukatpally', 'tarnaka', 'malakpet'];
        if (userObj) {
            userLogin(userObj["email"], userObj["password"], false);
        }

        async function userLogin(email, password, msg) {
            await signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    let userObj = {
                        location: email.split("@")[0],
                        email: email,
                        password: password
                    };

                    localStorage.setItem("invoisx", JSON.stringify(userObj));

                    if (userObj["location"] == "admin") {
                        window.location = "admin.html";
                    } else if (userObj["location"] == "finance") {
                        window.location = "finance.html";
                    }
                    document.getElementById('body').style.visibility = 'visible';
                })
                .catch((error) => {
                    window.location = "index.html";
                });
        }

        var proglab = document.getElementById('progressbar');
        var progressval = document.getElementById('progressval');
        var files = [];
        var reader = new FileReader();
        var input = document.getElementById('fileToUpload');

        input.onchange = e => {
            files = e.target.files;
            reader.readAsDataURL(files[0]);
            document.getElementById('fileName').innerHTML = files[0].name;
        }

        // const location = document.getElementById("location").value;
        //console.log(location);
        async function UploadProcess() {
            if (files.length == 0) {
                return;
            }
            proglab.style.visibility = 'visible'
            var ImgToUpload = files[0];
            const storage = getStorage();
            var date = new Date().toString();
            // console.log(date);
            const storageRef = sRef(storage, location + "/" + date);
            const UploadTask = uploadBytesResumable(storageRef, ImgToUpload);
            UploadTask.on('state-changed', (snapshot) => {
                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressval.innerHTML = progress.toFixed(0) + "%";
                progressval.style.width = progress.toFixed(0) + "%";

            },
                (error) => {
                    alert("error while uploading img!");
                }, async () => {
                    var dataContains = "";
                    var fd = new FormData();
                    fd.append('file', files[0]);
                    //document.getElementById('msg').innerHTML = "OCR scanning please wait!";
                    // await fetch("http://192.168.1.10:5000/img", { method: "post", body: fd })
                    //     .then(res => res.json())
                    //     .then(json => {
                    //         console.log(json.data);
                    //         dataContains = json.data;
                    //         document.getElementById('msg').innerHTML = "Success" + json.data;
                    //     })
                    //     .catch(err => document.getElementById('msg').innerHTML = "Success! Please Refresh!");

                    await getDownloadURL(UploadTask.snapshot.ref).then((downlaodURL) => {
                        const db = getDatabase();
                        const postData = {
                            date: date,
                            title: "",
                            location: location,
                            data: dataContains,
                            status: "pending",
                            link: downlaodURL,
                            fincmt: "Pending at approval",
                            admcmt: "Invoice under review",
                        }
                        console.log(date);
                        const updates = {};
                        const newPostKey = push(child(dRef(db), location)).key;
                        updates[`/${location}/` + newPostKey] = postData;
                        document.getElementById('modalInvoiceId').value = newPostKey;
                        document.getElementById('modalInvoiceLocation').value = location;

                        update(dRef(db), updates);
                    });
                    document.getElementById('msg').style.visibility = "visible";

                    setTimeout(function () {
                        window.location.reload(1);
                    }, 900);

                });
        }
        uploadBtn.onclick = UploadProcess;

        const dbRef = dRef(getDatabase());
        get(child(dbRef, `${location}`)).then((snapshot) => {
            if (snapshot.exists()) {
                const invoiceObj = {};
                snapshot.forEach(function (childSnapshot) {
                    invoiceObj['key'] = childSnapshot.key;
                    childSnapshot.forEach(function (grandChildSnapshot) {
                        invoiceObj[grandChildSnapshot.key] = grandChildSnapshot.val();
                    });
                    const status = `${invoiceObj.status}`;
                    const fincmt = `${invoiceObj.fincmt}`;
                    const admcmt = `${invoiceObj.admcmt}`;
                    //  console.log(invoiceObj.key)
                    document.getElementById('modalInvoiceId').value = `${invoiceObj.key}`;
                    document.getElementById('modalInvoiceLocation').value = `${invoiceObj.location}`;
                    if (invoiceObj.status == 'approved') {
                        document.getElementById('approvedN').innerHTML = 'Approved: ' + (parseInt(document.getElementById('approvedN').innerHTML.split(':')[1]) + 1);
                        addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-warning">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                        // document.getElementById('invoicesList').innerHTML = getInvoiceCard('warning',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                    }
                    else if (invoiceObj.status == 'pending') {
                        document.getElementById('pendingN').innerHTML = 'Pending: ' + (parseInt(document.getElementById('pendingN').innerHTML.split(':')[1]) + 1);
                        addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-primary">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                        // document.getElementById('invoicesList').innerHTML = getInvoiceCard('primary',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                    }
                    else if (invoiceObj.status == 'rejected') {
                        document.getElementById('rejectedN').innerHTML = 'Rejected: ' + (parseInt(document.getElementById('rejectedN').innerHTML.split(':')[1]) + 1);
                        addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-danger">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                        // document.getElementById('invoicesList').innerHTML = getInvoiceCard('danger',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                    }
                    else if (invoiceObj.status == 'paid') {
                        document.getElementById('paidN').innerHTML = 'Paid: ' + (parseInt(document.getElementById('paidN').innerHTML.split(':')[1]) + 1);
                        addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-success">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                        // document.getElementById('invoicesList').innerHTML = getInvoiceCard('success',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                    }

                });
            }
        }).catch((error) => {
            console.error(error);
        });

        async function deleteInvoice() {

            document.getElementById('launchSpinnerModal').click();

            const db = getDatabase();
            const id = document.getElementById('modalInvoiceId').value;
            const location = document.getElementById('modalInvoiceLocation').value;
            remove(dRef(db, `${location}/${id}`));
            setTimeout(function () {
                window.location.reload(1);
            }, 900);
        }




        /*adding row*/
        function addTableRow(a, b, c, d) {
            var table = $('#dataTable').DataTable();
            table.row.add([a, b, c, d]).draw();
        }

        document.getElementById('deleteBtn').onclick = deleteInvoice;
        /*logout listner*/
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    localStorage.removeItem("invoisx");
                    window.location = 'index.html';
                })
                .catch((error) => {
                    console.log(error);
                });
        });

    </script>
    <script>


        /*show invoice with comments*/
        function openInvoice(e, status, fincmt, admcmt) {
            const url = e.nextElementSibling.value;
            if (status == 'rejected') {
                document.getElementById('fincmtbox').style.display = 'none';
            }
            else {
                document.getElementById('fincmtbox').style.display = 'block';
                document.getElementById('fincmt').innerText = `${fincmt}`

            }
            if (status == 'pending') {
                document.getElementById('deleteBtn').style.display = 'block'
            }
            else {
                document.getElementById('deleteBtn').style.display = 'none'
            }
            document.getElementById('admcmt').innerText = `${admcmt}`


            document.getElementById('modalImg').src = url;
            document.getElementById('launchModal').click();


        }
        function customSearch(e) {
            $('#dataTable').DataTable().search(e.innerHTML.split(':')[0]).draw();
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>
</body>

</html>
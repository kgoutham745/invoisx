<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>INVOISX - Admin</title>
    <link rel="icon" type="image/jpg" href="/assets/images/logo.jpg">
    <!--unicons css <icons used>-->
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">
    <!--Bootstrap cdn link for custom css-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <!--google fonts for text font-->
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">
<!-- bootstrap icons  -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <!-- Custom styles for this template -->
    <link href="css/sb-admin-2.css" rel="stylesheet">
    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
    <!--css-->
    <style>
        /*Invoice detials css*/
        .left {
            text-align: right;
        }

        .right {
            text-align: left;
            font-weight: bold;
            padding-left: 10px;
        }
    </style>

</head>

<body class="bg-light-subtle py-5" id="body" style="visibility: hidden;">

    <!--navBar-->
    <nav class="navbar bg-body-tertiary shadow  fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="assets/images/logo.jpg" alt="Logo" width="50" class="d-inline-block align-text-top">
                INVOISX
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar"
                aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h5 class="offcanvas-title text-primary" id="offcanvasNavbarLabel">INVOISX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <!--profile code comes here-->
                <div class="offcanvas-body">
                    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                        <div class="accordion" id="accordionExample">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOne">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                        Admin
                                    </button>
                                </h2>
                                <div id="collapseOne" class="accordion-collapse collapse bg-light-subtle"
                                    aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <a class="nav-link active text-info" aria-current="page" href="#">Dashboard</a>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTwo">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                        Profile
                                    </button>
                                </h2>
                                <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                                    data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <li class="nav-item p-3 rounded border shadow-lg bg-white">
                                            <div class="text-center">
                                                <img src="assets/images/pic2.jpg" class="rounded-circle"
                                                    alt="Cinque Terre" width="100">
                                                <h4 id="profileName"> Kiran Acharya</h4>
                                            </div>
                                            <div class="">
                                                <i style="font-size: 20px;" class="bi bi-envelope m-2"></i>
                                                <p id="profileEmail">kiranacharya@gmail.com</p>
                                            </div>
                                            <div class="">
                                                <i style="font-size: 20px;" class="bi bi-telephone m-2"></i>
                                                <p id="profilePhone">+917623998725</p>
                                            </div>
                                            <div class="">
                                                <i style="font-size: 20px;" class="bi bi-geo-alt m-2"></i>
                                                <p id="profileLocation">Hyderabad</p>
                                            </div>
                                            <div class="text-center">
                                                <div class="accordion" id="accordionExampleInside">
                                                    <div class="accordion-item border-0">
                                                        <h2 class="accordion-header" id="headingInside">
                                                            <button class="btn btn-outline-dark" type="button"
                                                                data-bs-toggle="collapse"
                                                                data-bs-target="#collapseInside" aria-expanded="true"
                                                                aria-controls="collapseInside">
                                                                Change password
                                                            </button>
                                                        </h2>
                                                        <div id="collapseInside" class="accordion-collapse collapse"
                                                            aria-labelledby="headingInside"
                                                            data-bs-parent="#accordionExampleInside">
                                                            <div class="accordion-body">
                                                                <form id="changePasswordForm">
                                                                    <!--Old password-->
                                                                    <div class="form-floating mb-3 shadow">
                                                                        <input type="password" class="form-control"
                                                                            id="oldPassword" placeholder="Password">
                                                                        <label for="oldPassword">Old
                                                                            Password</label>
                                                                    </div>
                                                                    <!--New password-->
                                                                    <div class="form-floating mb-3 shadow">
                                                                        <input type="password" class="form-control"
                                                                            id="newPassword" placeholder="Password">
                                                                        <label for="newPassword">New
                                                                            Password</label>
                                                                    </div>
                                                                    <button type="button" id="changePasswordBtn"
                                                                        class="btn btn-primary">Proceed</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingThree">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseThree" aria-expanded="false"
                                        aria-controls="collapseThree">
                                        Add Store Managers
                                    </button>
                                </h2>
                                <div id="collapseThree" class="accordion-collapse text-center collapse bg-light-subtle"
                                    aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <form id="newUserForm">
                                            <!--name-->
                                            <div class="form-floating mb-3 shadow">
                                                <input type="text" class="form-control" id="newUserName"
                                                    placeholder="Name">
                                                <label for="floatingname">Name</label>
                                            </div>
                                            <!--email-->
                                            <div class="form-floating mb-3 shadow">
                                                <input type="email" class="form-control" id="newUserEmail"
                                                    aria-describedby="emailHelp" placeholder="Enter email">
                                                <label for="floatingemail">Email address</label>
                                            </div>
                                            <!--phone-->
                                            <div class="form-floating mb-3 shadow">
                                                <input type="text" class="form-control" id="newUserPhone"
                                                    placeholder="Phone">
                                                <label for="floatingphone">Phone</label>
                                            </div>
                                            <!--location-->
                                            <div class="form-floating mb-3 shadow">
                                                <input type="text" class="form-control" id="newUserLocation"
                                                    placeholder="location">
                                                <label for="floatinglocation">Location</label>
                                            </div>
                                            <!--password-->
                                            <div class="form-floating mb-3 shadow">
                                                <input type="password" class="form-control" id="newUserPassword"
                                                    placeholder="Password">
                                                <label for="floatingpassword">Password</label>
                                            </div>
                                            <button type="button" id="newUserCreateBtn"
                                                class="btn btn-primary">Proceed</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFour">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseFour" aria-expanded="false"
                                        aria-controls="collapseFour">
                                        Store Managers Activity
                                    </button>
                                </h2>
                                <div id="collapseFour" class="accordion-collapse text-center collapse bg-light-subtle"
                                    aria-labelledby="headingFour" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <form id="managerActivityForm">
                                            <label for="">Select Location</label>
                                            <select class="form-select mb-3 shadow" aria-label="Default select example" id="viewActivityLocation">
                                            </select>
                                            <button type="button" id="activityViewBtn"
                                                class="btn btn-primary">View</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFive">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseFive" aria-expanded="false"
                                        aria-controls="collapseFive">
                                        Add vendors
                                    </button>
                                </h2>
                                <div id="collapseFive" class="accordion-collapse text-center collapse bg-light-subtle"
                                    aria-labelledby="headingFive" data-bs-parent="#accordionExample">
                                    <div class="accordion-body">
                                        <form id="addVendorForm">
                                            <!--Location-->
                                            <label for="">Select Location</label>
                                            <select class="form-select mb-3 shadow" aria-label="Default select example" id="vendorLocation">
                                            </select>
                                            <!--Name-->
                                            <div class="form-floating mb-3 shadow">
                                                <input type="text" class="form-control" id="vendorName"
                                                    placeholder="Name">
                                                <label for="newPassword">Name</label>
                                            </div>
                                            <button type="button" id="addVendorBtn"
                                                class="btn btn-primary">Proceed</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <li class="nav-item m-1">
                            <button class="btn btn-outline-info" id="logoutBtn">Logout</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>


    <!--numbers-->
    <div class="container-fluid mt-4 text-center">
        <div class="card text-bg-light mb-3 shadow-lg">
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="p-3 bg-primary border border-0 rounded-2 bg-gradient text-white" id="Pending"
                            onclick="customSearch(this)" style="cursor: pointer;">
                            Pending:0
                        </div>
                    </div>
                    <div class="col">
                        <div class="p-3 bg-warning border border-0 rounded-2 bg-gradient text-white" id="Approved"
                            onclick="customSearch(this)" style="cursor: pointer;">
                            Approved:0
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="p-3 bg-danger border border-0 rounded-2 bg-gradient text-white" id="Rejected"
                            onclick="customSearch(this)" style="cursor: pointer;">
                            Rejected:0
                        </div>
                    </div>
                    <div class="col">
                        <div class="p-3 bg-success border border-0 rounded-2 bg-gradient text-white" id="Paid"
                            onclick="customSearch(this)" style="cursor: pointer;">
                            Paid:0
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--List of Invoices from fireBase-->
    <div class="container-fluid">
        <!-- DataTales Example -->
        <div class="card shadow-lg mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">List of Invoices:</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Id</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tfoot>
                            <tr>
                                <th>Date</th>
                                <th>Id</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </tfoot>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!--Page Footer-->
    <div class="footer" style="height: 2vh;text-align: center;">
        <p>
            All rights reserved &copy; 2023.
        </p>
    </div>


    <!--Triggers and Modals-->
    <!--Open invoice(open) Button trigger modal -->
    <button type="button" style="display: none;" id="launchModal" class="btn btn-primary" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop">
    </button>

    <!--Open Invoice Modal -->
    <div class="modal fade " id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-fullscreen-xl-down modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Invoice</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="row g-0">

                        <div class="col-md-8">
                            <img src="" id="modalImg" class="img-fluid rounded-start">
                        </div>

                        <div class="col-md-4 my-1 text-center border rounded shadow bg-light-subtle">
                            <div class="card-header bg-light-subtle">
                                <h6 class="m-0 font-weight-bold">Invoice Details:</h6>
                            </div>
                            <table align="center">
                                <tr>
                                    <td class="left">Invoice Number</td>
                                    <td class="right text-black" id="invoiceNo"></td>
                                </tr>

                                <tr>
                                    <td class="left">Status</td>
                                    <td class="right text-primary" id="status"></td>
                                </tr>

                                <tr>
                                    <td class="left">Manager Name</td>
                                    <td class="right text-danger" id="managerName"></td>
                                </tr>

                                <tr>
                                    <td class="left">Vendor Name</td>
                                    <td class="right text-danger" id="invoiceVendorName"></td>
                                </tr>

                                <tr>
                                    <td class="left">Invoice Date</td>
                                    <td class="right text-info" id="invoiceDate"></td>
                                </tr>

                                <tr>
                                    <td class="left">uploaded Date</td>
                                    <td class="right text-info" id="invoiceUploadDate"></td>
                                </tr>

                                <tr id="adminBox1">
                                    <td class="left" id="approvedByTag">Approved By</td>
                                    <td class="right text-warning" id="adminName"></td>
                                </tr>

                                <tr id="adminBox2">
                                    <td class="left" id="approvedDateTag">Approved Date</td>
                                    <td class="right text-warning" id="approvedDate"></td>
                                </tr>
                                <tr id="financeBox1">
                                    <td class="left">Paid By</td>
                                    <td class="right text-success" id="financerName"></td>
                                </tr>
                                <tr id="financeBox2" class="border-bottom">
                                    <td class="left">Paid Date</td>
                                    <td class="right text-success" id="paidDate"></td>
                                </tr>

                                <tr class="border-bottom">
                                    <td class="left">Amount</td>
                                    <td class="right text-success" id="amountInvoice"></td>
                                </tr>

                                <!-- <hr> -->
                                <tr>
                                    <td class="left">Admin Remarks</td>
                                    <td class="right" id="adminRemarks"></td>
                                </tr>
                                <tr class="border-bottom">
                                    <td class="left">Finance Remarks</td>
                                    <td class="right" id="financeRemarks"></td>
                                </tr>
                            </table>
                            <div class="form-floating m-3 mx-4 shadow" id="commentBox">
                                <input type="text" class="form-control" placeholder="Add Comment" id="commentText">
                                <label for="floatingname">Add Comment</label>
                            </div>

                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <!--delete invoice feature in updates-->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-secondary" id="deleteBtn">Delete</button>
                    <button type="button" class="btn btn-danger" id="rejectBtn">Reject</button>
                    <button type="button" class="btn btn-warning" id="approveBtn">Approve</button>
                    <input style="display:none" ; value="" id="modalInvoiceId"></input>
                    <input style="display:none" ; value="" id="modalInvoiceLocation"></input>
                    <input style="display:none" ; value="" id="modalInvoiceStatus"></input>
                </div>
            </div>
        </div>
    </div>
    


    <!--spinner triggering button-->
    <button type="button" class="btn btn-primary" style="display: none;" id="launchSpinnerModal" data-bs-toggle="modal"
        data-bs-target="#staticBackdrop2">
    </button>

    <!-- spinner modal -->
    <div class="modal fade" id="staticBackdrop2" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Please Wait!</h1>
                </div>
                <div class="modal-body text-center">
                    <!-- loading spinner -->
                    <button class="btn btn-primary" type="button">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Loading...
                    </button>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <button type="button" style="display: none;" id="viewActivityModalBtn" class="btn btn-primary" data-bs-toggle="modal"
        data-bs-target="#viewActivityModal">

    </button>
    <!-- view activiy Modal -->
    <div class="modal" id="viewActivityModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">User Activity</h4>
                    <button type="button" class="btn-close" style="display: none;" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <div class="table p-0">
                        <div class="row g-0 p-0">
                            <div class="col p-0">
                                <div class="text-end p-">
                                    <p class="fw-light" style="margin: 0px;">Name:</p>
                                    <p class="fw-light" style="margin: 0px;">Email:</p>
                                    <p class="fw-light" style="margin: 0px;">Phone:</p>
                                    <p class="fw-light" style="margin: 0px;">Location:</p>
                                    <p class="fw-light" style="margin: 0px;">Last login:</p>
                                    <p class="fw-light" style="margin: 0px;">Last logout:</p>
                                    <p class="fw-light" style="margin: 0px;">Last invoice upload:</p>
                                    <p class="fw-light" style="margin: 0px;">Invoices uploaded:</p>
                                    <p class="fw-light" style="margin: 0px;">Invoices deleted:</p>
                                </div>
                            </div>
                            <div class="col p-0">
                                <div class="text-start p-1">
                                    <p class="fw-bold" style="margin: 0px;" id="viewName"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewEmail"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewPhone"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewLocation"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewLastLogin"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewLastLogout"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewLastInvoiceUpload"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewInvoicesUploaded"></p>
                                    <p class="fw-bold" style="margin: 0px;" id="viewInvoicesDeleted"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

    <!-- toast message -->
    <button type="button" class="btn btn-primary" style="display: none;" id="liveToastBtn"></button>

    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-info-subtle">
                <img src="assets/images/logo.jpg" width="20" class="rounded me-2" alt="...">
                <strong class="me-auto" id="toastHeading"></strong>
                <small>just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body bg-info-subtle" id="toastMessage"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, updatePassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import { getDatabase, ref as dRef, set, get, child, update, push, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyCuhiAVSXUbzJseqTn8V9JIrSlq_g0GzoE",
            authDomain: "eroth-consultancy.firebaseapp.com",
            databaseURL: "https://eroth-consultancy-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "eroth-consultancy",
            storageBucket: "eroth-consultancy.appspot.com",
            messagingSenderId: "682903429693",
            appId: "1:682903429693:web:26c55686d06d2e4b7c8054",
            measurementId: "G-WL22HQMBKJ"
        };

        //configuring app
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const userObj = JSON.parse(localStorage.getItem("invoisx"));
        const locations = ['kukatpally', 'tarnaka', 'malakpet'];
        let adminName;

        if (userObj) {
            userLogin(userObj["email"], userObj["password"], false);
        } else {
            window.location = 'index.html';
        }

        const location = userObj["location"];

        //user login 
        async function userLogin(email, password, msg) {
            await signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    let userObj = {
                        location: email.split("@")[0],
                        email: email,
                        password: password,
                        lastLogin: new Date().toString().split('GMT')[0]
                    };
                    localStorage.setItem("invoisx", JSON.stringify(userObj));
                    const updates = {};
                    const db = getDatabase();
                    updates[`logs/${userObj['location']}/lastLogin`] = userObj['lastLogin'];
                    updates[`logs/${userObj['location']}/active`] = 'true';

                    update(dRef(db), updates).then(() => {
                        if (userObj["location"] == "finance") {
                            window.location = "finance.html";
                        } else if (userObj["location"] != "admin") {
                            window.location = "vendor.html";
                        } else {
                            document.getElementById('body').style.visibility = 'visible';
                        }
                    });
                })
                .catch((error) => {
                    window.location = "index.html";

                });
        }

        
        const dbRef = dRef(getDatabase());
        //populating the dataTable
        
        // locations.forEach(location => {
            get(child(dbRef, `/invoices/`)).then((locationSnapshot) => {
                let location;
                if (locationSnapshot.exists()) {
                    // console.log();
                    const invoiceObj = {};
                    locationSnapshot.forEach(function (snapshot){
                        location = snapshot.key;
                    snapshot.forEach(function (childSnapshot) {
                        invoiceObj['key'] = childSnapshot.key;

                        childSnapshot.forEach(function (grandChildSnapshot) {
                            invoiceObj[grandChildSnapshot.key] = grandChildSnapshot.val();
                        });

                        let color;
                        let differCard = invoiceObj.status;

                        document.getElementById('modalInvoiceId').value = `${invoiceObj.key}`;
                        document.getElementById('modalInvoiceLocation').value = `${location}`;

                        ///openInvoice(invoiceObj)<button type="button" class="btn btn-primary btn-sm" id="open" onclick="openInvoice(invoiceObj)">Open</button>
                        if (invoiceObj.status == 'Approved') {
                            color = 'warning';

                            ///document.getElementById('approvedN').innerHTML = 'Approved: ' + (parseInt(document.getElementById('approvedN').innerHTML.split(':')[1]) + 1);
                            // addTableRow(`${invoiceObj.uploadDate}`, `<div class="badge text-bg-warning">${invoiceObj.status}</div>`, `${location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice('${encodeURIComponent(JSON.stringify(invoiceObj))}')">Open</button>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('warning',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                            // document.getElementById("open").addEventListener("click", openInvoice(obj));
                            // addTableRow(`${invoiceObj.uploadDate}`, `<div class="badge text-bg-warning">${invoiceObj.status}</div>`, `${location}`, invoiceObj);


                        }
                        else if (invoiceObj.status == 'Pending') {
                            color = 'primary';


                            //document.getElementById('Pending').innerHTML = 'Pending: ' + (parseInt(document.getElementById('pendingN').innerHTML.split(':')[1]) + 1);
                            // addTableRow(`${invoiceObj.uploadDate}`, `<div class="badge text-bg-primary">${invoiceObj.status}</div>`, `${location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice('${encodeURIComponent(JSON.stringify(invoiceObj))}')">Open</button>`);
                            // addTableRow(`${invoiceObj.uploadDate}`, `<div class="badge text-bg-primary">${invoiceObj.status}</div>`, `${location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice('${invoiceObj}', this)">Open</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-primary">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('primary',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }
                        else if (invoiceObj.status == 'Rejected') {
                            color = 'danger';

                            /// document.getElementById('pendingN').innerHTML = 'Rejected: ' + (parseInt(document.getElementById('rejectedN').innerHTML.split(':')[1]) + 1);
                            // addTableRow(`${invoiceObj.uploadDate}`, `<div class="badge text-bg-danger">${invoiceObj.status}</div>`, `${location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice('${encodeURIComponent(JSON.stringify(invoiceObj))}')">Open</button>`);
                            //addTableRow(`${invoiceObj.uploadDate}`, `<div class="badge text-bg-danger">${invoiceObj.status}</div>`, `${location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice('${invoiceObj}')">Open</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            //addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-danger">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('danger',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }
                        else if (invoiceObj.status == 'Paid') {
                            color = 'success'

                            /// document.getElementById('paidN').innerHTML = 'Paid: ' + (parseInt(document.getElementById('paidN').innerHTML.split(':')[1]) + 1);
                            //addTableRow(`${invoiceObj.uploadDate}`, `<div class="badge text-bg-success">${invoiceObj.status}</div>`, `${location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice('${invoiceObj}')">Open</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // addTableRow(`${invoiceObj.date.substring(0, 16)}`, `<div class="badge text-bg-success">${invoiceObj.status}</div>`, `${invoiceObj.location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${status}','${fincmt}','${admcmt}')">Details</button><input style="display:none;" value="${invoiceObj.link}"></input>`);
                            // document.getElementById('invoicesList').innerHTML = getInvoiceCard('success',invoiceObj) + document.getElementById('invoicesList').innerHTML;
                        }
                        document.getElementById(`${differCard}`).innerHTML = `${differCard}` + ':' + (parseInt(document.getElementById(`${differCard}`).innerHTML.split(':')[1]) + 1);
                        addTableRow(`${invoiceObj.uploadDate}`, `${invoiceObj.key}`, `<div class="badge text-bg-${color}">${invoiceObj.status}</div>`, `${invoiceObj.amount}`, `${location}`, `<button type="button" class="btn btn-primary btn-sm" onclick="openInvoice(this,'${encodeURIComponent(JSON.stringify(invoiceObj))}')">Open</button><input style="display:none;" value="${invoiceObj.key}"></input><input style="display:none;" value="${location}"></input>`);


                    });
                    })
                }

            }).catch((error) => {
                console.error(error);
            });
        // });
        
        function getDate(){
            let date = new Date();
            let dd = String(date.getDate()).padStart(2, '0');
            let mm = String(date.getMonth() + 1).padStart(2, '0');
            let yyyy = date.getFullYear();
            date = dd + '/' + mm + '/' + yyyy;
return date;
        }
        //approving invoice
        async function approveInvoice() {
            document.getElementById('launchSpinnerModal').click();

            const db = getDatabase();
            const updates = {};
            const id = document.getElementById('modalInvoiceId').value;
            const location = document.getElementById('modalInvoiceLocation').value;

            let text = "No Comments"

            if (document.getElementById('commentText').value.trim().length > 0)
                text = document.getElementById('commentText').value;

            let approveDate = getDate();

            updates[`/invoices/${location}/` + id + '/status'] = "Approved";
            updates[`/invoices/${location}/` + id + '/adminRemarks'] = text;
            updates[`/invoices/${location}/` + id + '/approveDate'] = approveDate;
            
            //admin name??

            update(dRef(db), updates)

            setTimeout(function () {
                window.location.reload(1);
            }, 900);

        }

        //rejecting the invoice        
        async function rejectInvoice() {
            document.getElementById('launchSpinnerModal').click();
            const db = getDatabase();
            const updates = {};
            const id = document.getElementById('modalInvoiceId').value;
            const location = document.getElementById('modalInvoiceLocation').value;
            let text = "No Comments"
            if (document.getElementById('commentText').value.trim().length > 0)
                text = document.getElementById('commentText').value;


            updates[`/invoices/${location}/` + id + '/status'] = "Rejected";
            updates[`/invoices/${location}/` + id + '/rejectDate'] = getDate();
            updates[`/invoices/${location}/` + id + '/rejectBy'] = adminName;
            updates[`/invoices/${location}/` + id + '/financeRemarks'] = text;
            update(dRef(db), updates)
            setTimeout(function () { window.location.reload(1); }, 900);
        }


        /*delete invoices*/
        async function deleteInvoice() {
            document.getElementById('launchSpinnerModal').click();
            const db = getDatabase();
            const id = document.getElementById('modalInvoiceId').value;
          
            const location = document.getElementById('modalInvoiceLocation').value;
           
            remove(dRef(db, `/invoices/${location}/${id}`));
            setTimeout(function () {
                window.location.reload(1);
            }, 900);
        }

        /*event listners*/
        document.getElementById('approveBtn').onclick = approveInvoice;
        document.getElementById('rejectBtn').onclick = rejectInvoice;



        /*adding row*/
        function addTableRow(a, b, c, d, e, f) {
            var table = $('#dataTable').DataTable();
            table.row.add([a, b, c, d, e, f]).draw();
        }



        //logout event
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    const userObj = JSON.parse(localStorage.getItem("invoisx"));
                    const updates = {};
                    const db = getDatabase();
                    updates[`logs/${userObj['location']}/lastLogout`] = new Date().toString().split('GMT')[0];
                    updates[`logs/${userObj['location']}/active`] = 'false';
                    localStorage.removeItem("invoisx");
                    update(dRef(db), updates).then(() => {
                        window.location = 'index.html';
                    });
                })
                .catch((error) => {
                    console.log(error);
                });
        });

        //creating a new user
        function createNewUser(email, password) {
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in 
                    const db = getDatabase();
                    const user = userCredential.user;
                    const updates = {};
                    const location = document.getElementById('newUserLocation').value;
                    updates[`logs/${location}/name`] = document.getElementById('newUserName').value;
                    updates[`logs/${location}/email`] = document.getElementById('newUserEmail').value;
                    updates[`logs/${location}/phone`] = document.getElementById('newUserPhone').value;
                    updates[`logs/${location}/location`] = location;
                    updates[`logs/${location}/lastLogin`] = '-';
                    updates[`logs/${location}/active`] = 'false';
                    updates[`logs/${location}/lastInvoiceUpload`] = '-';
                    updates[`logs/${location}/invoicesUploaded`] = '-';
                    updates[`logs/${location}/invoicesDeleted`] = '-';

                    update(dRef(db), updates).then(() => {
                        document.getElementById('toastHeading').innerHTML = 'Message';
                        document.getElementById('toastMessage').innerHTML = 'User created successfully!';
                        document.getElementById('liveToastBtn').click();
                        document.getElementById('newUserForm').reset();
                    });

                    // ...
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    document.getElementById('toastHeading').innerHTML = 'Error';
                    document.getElementById('toastMessage').innerHTML = errorMessage;
                    document.getElementById('liveToastBtn').click();
                    // ..
                });
        }
        document.getElementById("newUserCreateBtn").addEventListener('click', () => {
            document.getElementById('toastHeading').innerHTML = 'Warning';
            if (document.getElementById('newUserName').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Name cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }
            if (document.getElementById('newUserEmail').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Email cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }
            if (document.getElementById('newUserPhone').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Phone cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }
            if (document.getElementById('newUserLocation').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Location cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return
            }
            if (document.getElementById('newUserPassword').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Password cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }

            createNewUser(document.getElementById('newUserEmail').value, document.getElementById('newUserPassword').value);
        });
        document.getElementById('deleteBtn').onclick = deleteInvoice;
        //change password
        function changePassword(oldPassword, newPassword) {
            const user = auth.currentUser;
            updatePassword(user, newPassword).then(() => {
                // Update successful.
                document.getElementById('toastHeading').innerHTML = 'Notification';
                document.getElementById('toastMessage').innerHTML = 'Password updated successfully!';
                document.getElementById('liveToastBtn').click();
                document.getElementById('changePasswordForm').reset();

            }).catch((error) => {
                // An error ocurred
                document.getElementById('toastHeading').innerHTML = 'Error';
                document.getElementById('toastMessage').innerHTML = error;
                document.getElementById('liveToastBtn').click();
            });
        }
        document.getElementById('changePasswordBtn').addEventListener('click', () => {
            document.getElementById('toastHeading').innerHTML = 'Warning';
            if (document.getElementById('oldPassword').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Old Password cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }
            if (document.getElementById('newPassword').value == "") {
                document.getElementById('toastMessage').innerHTML = 'New Password cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }
            changePassword(document.getElementById('oldPassword').value, document.getElementById('newPassword').value);
        });

        //trigerring toast message
        const toastTrigger = document.getElementById('liveToastBtn')
        const toastLiveExample = document.getElementById('liveToast')
        if (toastTrigger) {
            toastTrigger.addEventListener('click', () => {
                const toast = new bootstrap.Toast(toastLiveExample)

                toast.show()
            })
        }
        //fetch profile details
        function viewProfile() {
            const userObj = JSON.parse(localStorage.getItem("invoisx"));
            const dbRef = dRef(getDatabase());
            // console.log(userObj);
            get(child(dbRef, 'logs/' + userObj['location'])).then((snapshot) => {
                let profileObj = {};
                snapshot.forEach(function (childSnapshot) {
                    profileObj[childSnapshot.key] = childSnapshot.val();
                });
                document.getElementById('profileName').innerHTML = profileObj['name'];
                adminName = profileObj['name'];
                document.getElementById('profileEmail').innerHTML = profileObj['email'];
                document.getElementById('profilePhone').innerHTML = profileObj['phone'];
                document.getElementById('profileLocation').innerHTML = profileObj['location'];
            });
        }
        viewProfile();

        //adding vendors(companies)
        function addVendor(location, name) {
            const updates = {};
            const db = getDatabase();
            updates[`vendors/${location}/${name}`] = "";
            update(dRef(db), updates).then(() => {
                document.getElementById('toastHeading').innerHTML = 'Notification';
                document.getElementById('toastMessage').innerHTML = 'Vendor Added successfully!';
                document.getElementById('liveToastBtn').click();
                document.getElementById('addVendorForm').reset();
            });
        }
        document.getElementById('addVendorBtn').addEventListener('click', () => {
            document.getElementById('toastHeading').innerHTML = 'Warning';
            if (document.getElementById('vendorLocation').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Location cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }
            if (document.getElementById('vendorName').value == "") {
                document.getElementById('toastMessage').innerHTML = 'Name cannot be empty!';
                document.getElementById('liveToastBtn').click();
                return;
            }
            addVendor(document.getElementById('vendorLocation').value, document.getElementById('vendorName').value);
        });

        //fetch all stores for viewing activity
        function fetchStores(){
            const dbRef = dRef(getDatabase());
            get(child(dbRef, 'logs')).then((snapshot) => {
                const select1 = document.getElementById('viewActivityLocation');
                const select2 = document.getElementById('vendorLocation');
                snapshot.forEach(function (childSnapshot) {
                    // console.log(childSnapshot.key);
                    if(childSnapshot.key == 'admin' || childSnapshot.key == 'finance'){
                        //skip
                    }else{
                        const option1 = document.createElement('option');
                        option1.text = childSnapshot.key;
                        option1.value = childSnapshot.key;
                        const option2 = document.createElement('option');
                        option2.text = childSnapshot.key;
                        option2.value = childSnapshot.key;
                        select1.add(option1);
                        select2.add(option2);
                        locations.push(childSnapshot.key);
                    }
                });
            });
        }
        fetchStores();

        //view store manager activity
        function viewActivity(location) {
            const dbRef = dRef(getDatabase());
            // console.log(location);
            get(child(dbRef, 'logs/' + location)).then((snapshot) => {
                // console.log("inside");
                let profileObj = {};
                snapshot.forEach(function (childSnapshot) {
                    profileObj[childSnapshot.key] = childSnapshot.val();
                });
                // console.log(profileObj);
                document.getElementById('viewName').innerHTML = profileObj['name'];
                document.getElementById('viewEmail').innerHTML = profileObj['email'];
                document.getElementById('viewPhone').innerHTML = profileObj['phone'];
                document.getElementById('viewLocation').innerHTML = profileObj['location'];
                document.getElementById('viewLastLogin').innerHTML = profileObj['lastLogin'];
                document.getElementById('viewLastLogout').innerHTML = profileObj['lastLogout'];
                document.getElementById('viewLastInvoiceUpload').innerHTML = profileObj['lastInvoiceUpload'];
                document.getElementById('viewInvoicesUploaded').innerHTML = profileObj['invoicesUploaded'];
                document.getElementById('viewInvoicesDeleted').innerHTML = profileObj['invoicesDeleted'];
                document.getElementById('viewActivityModalBtn').click();
            });
        }
        document.getElementById('activityViewBtn').addEventListener('click',()=>{
            console.log('working');
            viewActivity(document.getElementById('viewActivityLocation').value);
        });

        //fetch admin and finance name
        function adminFinance(){
            get(child(dbRef, 'logs/admin/name' )).then((snapshot) => {
                document.getElementById('adminName').innerHTML = snapshot.val();
            });
            get(child(dbRef, 'logs/finance/name' )).then((snapshot) => {
                document.getElementById('financerName').innerHTML = snapshot.val();
            }).catch((err)=>{ console.log(err) });
        }
        adminFinance();

    </script>
    <script>
        function openInvoice(e,invoiceObj) {
            invoiceObj = JSON.parse(decodeURIComponent(invoiceObj))
            const url = invoiceObj.link;
            const status = invoiceObj.status;

            document.getElementById('invoiceNo').innerHTML = invoiceObj['key'];
            document.getElementById('status').innerHTML = invoiceObj['status'];
            document.getElementById('managerName').innerHTML = invoiceObj['managerName'];
            document.getElementById('invoiceVendorName').innerHTML = invoiceObj['vendorName'];
            document.getElementById('invoiceDate').innerHTML = invoiceObj['invoiceDate'];
            document.getElementById('invoiceUploadDate').innerHTML = invoiceObj['uploadDate'];
           
            document.getElementById('approvedDate').innerHTML = invoiceObj['approveDate'];
          
            document.getElementById('paidDate').innerHTML = invoiceObj['paidDate'];
            document.getElementById('amountInvoice').innerHTML = invoiceObj['amount'];
            
            document.getElementById('adminRemarks').innerHTML = invoiceObj['adminRemarks'];
            document.getElementById('financeRemarks').innerHTML = invoiceObj['financeRemarks'];

            if(status=='Rejected'){
                document.getElementById('approvedByTag').innerHTML = 'Rejected By';
                document.getElementById('approvedDateTag').innerHTML = 'Rejected Date';
                document.getElementById('approvedDate').innerHTML = invoiceObj['rejectDate'];
                document.getElementById('adminName').innerHTML = invoiceObj['rejectBy'];
            }else{
                document.getElementById('approvedByTag').innerHTML = 'Approved By';
                document.getElementById('approvedDateTag').innerHTML = 'Approved Date';
                document.getElementById('approvedDate').innerHTML = invoiceObj['approveDate'];
            }

            if (status == 'Pending') {
                document.getElementById('approveBtn').style.display = 'block'
                document.getElementById('rejectBtn').style.display = 'block'
                document.getElementById('commentBox').style.display = 'block';
                document.getElementById('adminBox1').style.display = 'none';
                document.getElementById('financeBox1').style.display = 'none';
                document.getElementById('adminBox2').style.display = 'none';
                document.getElementById('financeBox2').style.display = 'none';
            }
           else if (status == 'Approved' || status == 'Rejected') {
            
                document.getElementById('approveBtn').style.display = 'none'
                document.getElementById('rejectBtn').style.display = 'none'
                document.getElementById('commentBox').style.display = 'none';
                document.getElementById('financeBox1').style.display = 'none';
                document.getElementById('financeBox2').style.display = 'none';
                document.getElementById('adminBox1').style.display = 'table-row';
                document.getElementById('adminBox2').style.display = 'table-row';
            }

            else if (status == 'Paid') {
            
                document.getElementById('approveBtn').style.display = 'none'
                document.getElementById('rejectBtn').style.display = 'none'    
                document.getElementById('commentBox').style.display = 'none';
                document.getElementById('adminBox1').style.display = 'table-row';
                document.getElementById('adminBox2').style.display = 'table-row';
                document.getElementById('financeBox1').style.display = 'table-row';
                document.getElementById('financeBox2').style.display = 'table-row';
            }

            /*setting key and location*/
            const id = e.nextElementSibling.value;
            const loc = e.nextElementSibling.nextElementSibling.value;
            

            document.getElementById('modalInvoiceLocation').value = loc;
            document.getElementById('modalInvoiceId').value = id;

            document.getElementById('modalImg').src = url;
            document.getElementById('launchModal').click();


        }

        //setting drop down values
        function setOption(id) {
            document.getElementById('dropDown').innerText = id;
        }
        function customSearch(e) {
            $('#dataTable').DataTable().search(e.innerHTML.split(':')[0]).draw();
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>
</body>

</html>